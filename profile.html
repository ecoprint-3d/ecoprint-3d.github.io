<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç - –≠–∫–æ –ü—Ä–∏–Ω—Ç</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/profile.css">
    <link rel="stylesheet" href="css/profile-orders.css">
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-E66PPP1FTP"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-E66PPP1FTP');
</script>
<body>
    <!-- –®–∞–ø–∫–∞ —Å–∞–π—Ç–∞ -->
    <div id="header"></div>
    
    <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞ -->
    <section class="profile-page">
        <div class="profile-container">
            <div class="profile-header">
                <div class="profile-avatar">üë§</div>
                <h1 id="userName">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h1>
                <p id="userEmail">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
            </div>

            <div class="profile-info">
                <!-- –ë–æ–Ω—É—Å–Ω—ã–π –±–∞–ª–∞–Ω—Å -->
                <div class="bonus-balance">
                    <div class="bonus-label">–í–∞—à –±–æ–Ω—É—Å–Ω—ã–π –±–∞–ª–∞–Ω—Å</div>
                    <div class="bonus-amount" id="bonusBalance">0</div>
                    <div class="bonus-label">–±–∞–ª–ª–æ–≤</div>
                </div>

                <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                <div class="info-grid">
                    <div class="info-card">
                        <h3>–õ–∏—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                        <div class="info-item">
                            <span class="info-label">–§–ò–û:</span>
                            <span class="info-value" id="userFullName">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Email:</span>
                            <span class="info-value" id="userEmailInfo">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">–†–æ–ª—å:</span>
                            <span class="info-value" id="userRole">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</span>
                            <span class="info-value" id="registrationDate">-</span>
                        </div>
                    </div>

                    <div class="info-card">
                        <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                        <div class="info-item">
                            <span class="info-label">–í—Å–µ–≥–æ —Å–¥–∞–Ω–æ –ø–ª–∞—Å—Ç–∏–∫–∞:</span>
                            <span class="info-value" id="totalPlastic">0 –∫–≥</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">–í—Å–µ–≥–æ –æ–ø–µ—Ä–∞—Ü–∏–π:</span>
                            <span class="info-value" id="totalOperations">0</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">–ó–∞–∫–∞–∑–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ:</span>
                            <span class="info-value" id="completedOrders">0</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">–≠–∫–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –≤–∫–ª–∞–¥:</span>
                            <span class="info-value" id="ecoImpact">0 –∫–≥ CO‚ÇÇ</span>
                        </div>
                    </div>
                </div>

                <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ -->
                <h2 class="section-title">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</h2>
                <div class="operations-list" id="operationsList">
                    <!-- –û–ø–µ—Ä–∞—Ü–∏–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                </div>

                <h2 class="section-title">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</h2>
                <div class="orders-list" id="ordersList">
                    <!-- –ó–∞–∫–∞–∑—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                </div>

                <!-- –î–µ–π—Å—Ç–≤–∏—è -->
                <div class="profile-actions">
                    <a href="catalog.html" class="action-btn">üõçÔ∏è –ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–∞—Ç–∞–ª–æ–≥</a>
                    <a href="recycle.html" class="action-btn">‚ôªÔ∏è –°–¥–∞—Ç—å –ø–ª–∞—Å—Ç–∏–∫</a>
                    <button class="action-btn secondary" onclick="logout()">üö™ –í—ã–π—Ç–∏</button>
                </div>
            </div>
        </div>
    </section>

    <!-- –ü–æ–¥–≤–∞–ª -->
    <div id="footer"></div>
    <script src="js/common.js"></script>

    <script src="js/utils.js"></script>
    <script src="js/data.js"></script>
    <script>
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function loadProfileData() {
            const currentUser = API.getCurrentUser();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
            if (!currentUser) {
                alert('–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ª–∏—á–Ω–æ–º—É –∫–∞–±–∏–Ω–µ—Ç—É –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É');
                window.location.href = 'login.html';
                return;
            }
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                const allUsers = await API.getUsers();
                const userData = allUsers.find(u => u.id === currentUser.id) || currentUser;
                
                // –ü–æ–ª—É—á–∞–µ–º –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const allDeposits = await API.getDeposits();
                const userDeposits = allDeposits.filter(d => d.userId === currentUser.id);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ —à–∞–ø–∫–µ
                document.getElementById('userName').textContent = userData.name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                document.getElementById('userEmail').textContent = userData.email;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                document.getElementById('userFullName').textContent = userData.name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
                document.getElementById('userEmailInfo').textContent = userData.email;
                document.getElementById('userRole').textContent = userData.role === 'operator' ? '–û–ø–µ—Ä–∞—Ç–æ—Ä' : '–£—á–∞—Å—Ç–Ω–∏–∫';
                document.getElementById('registrationDate').textContent = userData.registrationDate || '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
                document.getElementById('bonusBalance').textContent = userData.bonusBalance || 0;
                
                // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                const totalPlastic = userDeposits.reduce((sum, deposit) => sum + parseFloat(deposit.weight || 0), 0);
                const totalOperations = userDeposits.length;
                const ecoImpact = Math.round(totalPlastic * 2.5); // –ü—Ä–∏–º–µ—Ä–Ω—ã–π —Ä–∞—Å—á–µ—Ç CO‚ÇÇ
                
                // –°—á–∏—Ç–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã
                const orders = JSON.parse(sessionStorage.getItem('orders')) || [];
                const userOrders = orders.filter(order => order.userId === currentUser.id);
                const completedOrders = userOrders.filter(order => order.status === 'completed').length;
                
                document.getElementById('totalPlastic').textContent = `${totalPlastic.toFixed(1)} –∫–≥`;
                document.getElementById('totalOperations').textContent = totalOperations;
                document.getElementById('completedOrders').textContent = completedOrders;
                document.getElementById('ecoImpact').textContent = `${ecoImpact} –∫–≥ CO‚ÇÇ`;
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
                loadRecentOperations(userDeposits);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è');
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
        function loadRecentOperations(userDeposits) {
            const operationsList = document.getElementById('operationsList');
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ (—Å–∞–º—ã–µ –Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏)
            const sortedDeposits = [...userDeposits].sort((a, b) => {
                return new Date(b.date || 0) - new Date(a.date || 0);
            });
            
            const recentOperations = sortedDeposits.slice(0, 5); // –ü–µ—Ä–≤—ã–µ 5 –æ–ø–µ—Ä–∞—Ü–∏–π
            
            if (recentOperations.length === 0) {
                operationsList.innerHTML = '<div class="no-data">–û–ø–µ—Ä–∞—Ü–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</div>';
                return;
            }
            
            operationsList.innerHTML = recentOperations.map(deposit => `
                <div class="operation-item">
                    <div class="operation-icon">‚ôªÔ∏è</div>
                    <div class="operation-details">
                        <div class="operation-type">–°–¥–∞—á–∞ –ø–ª–∞—Å—Ç–∏–∫–∞</div>
                        <div class="operation-info">${deposit.weight} –∫–≥ ${deposit.plasticType || '–ø–ª–∞—Å—Ç–∏–∫–∞'}</div>
                        <div class="operation-info">
                            –ù–∞—á–∏—Å–ª–µ–Ω–æ: <span class="bonus-positive">+${deposit.bonusAmount} –±–∞–ª–ª–æ–≤</span>
                        </div>
                        <div class="operation-date">${deposit.date || '–î–∞—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞'}</div>
                    </div>
                </div>
            `).join('');
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function loadUserOrders() {
            const currentUser = API.getCurrentUser();
            if (!currentUser) return;
            
            const orders = JSON.parse(sessionStorage.getItem('orders')) || [];
            const userOrders = orders.filter(order => order.userId === currentUser.id)
                .sort((a, b) => b.id - a.id);
            
            const ordersList = document.getElementById('ordersList');
            
            if (userOrders.length === 0) {
                ordersList.innerHTML = '<div class="no-data">–ó–∞–∫–∞–∑–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>';
                return;
            }
            
            ordersList.innerHTML = userOrders.map(order => {
                // –°—á–∏—Ç–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤
                const totalItems = order.items.reduce((sum, item) => sum + item.quantity, 0);
                
                return `
                <div class="order-card">
                    <div class="order-header">
                        <div class="order-number">–ó–∞–∫–∞–∑ ${order.orderNumber}</div>
                        <div class="order-status ${order.status}">${getStatusText(order.status)}</div>
                    </div>
                    <div class="order-details">
                        <div class="order-info">
                            <div><strong>–î–∞—Ç–∞:</strong> ${order.createdAt}</div>
                            <div><strong>–ü—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏:</strong> ${Utils.getPickupPointFullName(order.pickupPoint)}</div>
                            <div><strong>–¢–æ–≤–∞—Ä–æ–≤:</strong> ${totalItems} —à—Ç.</div>
                            <div><strong>–û–ø–ª–∞—á–µ–Ω–æ –±–æ–Ω—É—Å–∞–º–∏:</strong> ${order.bonusUsed} –±–∞–ª–ª–æ–≤</div>
                            <div><strong>–ò—Ç–æ–≥–æ:</strong> ${Utils.formatPrice(order.finalPrice)}</div>
                        </div>
                        <div class="order-items-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th>–¢–æ–≤–∞—Ä</th>
                                        <th>–ö–æ–ª-–≤–æ</th>
                                        <th>–¶–µ–Ω–∞</th>
                                        <th>–°—É–º–º–∞</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${order.items.map(item => `
                                        <tr>
                                            <td>${item.name}</td>
                                            <td>${item.quantity}</td>
                                            <td>${Utils.formatPrice(item.price)}</td>
                                            <td>${Utils.formatPrice(item.price * item.quantity)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        // –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—É—Å–∞ (–æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å)
        function getStatusText(status) {
            const statuses = {
                'pending': '–û–∂–∏–¥–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏',
                'processing': '–í –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ',
                'ready': '–ì–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ',
                'completed': '–í—ã–¥–∞–Ω'
            };
            return statuses[status] || status;
        }

        function logout() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
                sessionStorage.removeItem("currentUser");
                window.location.href = 'index.html';
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', async function() {
            await loadProfileData();
            await loadUserOrders();
        });
    </script>

</body>
</html>